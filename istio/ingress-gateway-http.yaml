apiVersion: v1
kind: Service
metadata:
  name: istio-ingressgateway-http
  namespace: ingress-istio
spec:
  type: NodePort
  #
  # internalTrafficPolicy: Local
  # Cluster（默认值）：流量可以转发到集群中任何节点上的Pod，即使需要跨节点转发。这会进行SNAT（源网络地址转换），导致Pod看到的源IP变为节点的IP，但负载均衡更均匀。
  # Local：流量只路由到接收请求的本地节点上的Pod，不会跨节点转发。这保留了客户端的原始源IP，提高性能（减少一次网络跳跃），但如果本地节点无匹配Pod，流量可能被丢弃，导致负载不均衡。
  #  
  externalTrafficPolicy: Local 
  internalTrafficPolicy: Cluster
  selector:
    istio: istio-ingressgateway-http
  ports:
  - port: 80
    name: http
  - port: 443
    name: https
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: istio-ingressgateway-http
  namespace: ingress-istio
spec:
  selector:
    matchLabels:
      istio: istio-ingressgateway-http
  template:
    metadata:
      annotations:
        # 选择网关注入模板（而不是默认的 Sidecar 模板）
        inject.istio.io/templates: gateway
      labels:
        # 为网关设置唯一标签。这是确保 Gateway 可以选择此工作负载所必需的
        istio: istio-ingressgateway-http
        # 启用网关注入。如果后续连接到修订版的控制平面，请替换为 `istio.io/rev: revision-name`
        sidecar.istio.io/inject: "true"
    spec:
      # 允许绑定到所有端口（例如 80 和 443）
      securityContext:
        sysctls:
        - name: net.ipv4.ip_unprivileged_port_start
          value: "0"
      containers:
      - name: istio-proxy
        image: auto # 每次 Pod 启动时，该镜像都会自动更新。
        # 放弃所有 privilege 特权，允许以非 root 身份运行
        securityContext:
          capabilities:
            drop:
            - ALL
          runAsUser: 1337
          runAsGroup: 1337
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: istio-ingressgateway-http
  namespace: ingress-istio
  labels:
    app: istio-ingressgateway-http
spec:
  minReplicas: 3
  maxReplicas: 8
  metrics:
    - resource:
        name: cpu
        target:
          averageUtilization: 100
          type: Utilization
      type: Resource
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: istio-ingressgateway-http
---
# 设置 Role 以允许读取 TLS 凭据
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: istio-ingressgateway-sds
  namespace: ingress-istio
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: istio-ingressgateway-sds
  namespace: ingress-istio
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: istio-ingressgateway-sds
subjects:
- kind: ServiceAccount
  name: default